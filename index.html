<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <title>Вики Мастер Преводилац (Поправљен QID)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1300px; margin: 20px auto; padding: 20px; background: #f0f2f5; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 3px solid #3366cc; padding-bottom: 10px; margin-top: 0; }
        h3 { color: #555; margin: 20px 0 10px 0; border-left: 4px solid #3366cc; padding-left: 10px; }
        
        .import-section { background: #eef2f7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #d1d9e6; }
        .import-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        select, input[type="text"] { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
        input[type="text"] { flex-grow: 1; }
        .custom-lang { width: 60px !important; flex-grow: 0 !important; text-align: center; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 10px; }
        textarea { width: 100%; height: 250px; padding: 12px; border: 2px solid #ced4da; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; box-sizing: border-box; resize: vertical; }
        
        button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-import { background-color: #3366cc; color: white; }
        .btn-extract { background-color: #6c757d; color: white; width: 100%; margin-top: 5px; }
        .btn-main { background-color: #202122; color: white; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn-cat { background-color: #0056b3; color: white; width: 100%; font-size: 16px; margin-top: 10px; }
        
        .btn-tool { background-color: #e0e0e0; color: #333; margin: 2px; font-size: 11px; padding: 5px 8px; font-weight: bold; }
        .btn-tool:hover { background-color: #bdbdbd; }
        .btn-unified { background-color: #ff9800 !important; color: white !important; }

        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background-color: #aaa; cursor: not-allowed; opacity: 0.6; }

        .output-box { width: 100%; min-height: 100px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #fff; font-family: 'Courier New', monospace; white-space: pre-wrap; word-wrap: break-word; margin-bottom: 20px; }
        .found { color: #1b5e20; font-weight: bold; background-color: #e8f5e9; padding: 2px 4px; border-radius: 3px; display: block; margin-bottom: 2px; } 
        .not-found { color: #b71c1c; font-weight: bold; background-color: #ffebee; padding: 2px 4px; border-radius: 3px; display: block; margin-bottom: 2px; }

        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; }
        th { background-color: #f8f9fa; }
        .status-msg { font-weight: bold; margin: 15px 0; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid transparent; }
        .section-divider { border-top: 4px double #3366cc; margin: 40px 0; }
        a { color: #3366cc; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <h2>Вики Мастер Преводилац (Поправљен QID)</h2>

    <div class="import-section">
        <h3>0. Аутоматско преузимање чланка</h3>
        <div class="import-controls">
            <select id="langSelect">
                <option value="en" selected>Енглеска (en)</option>
                <option value="ceb">Себуано (ceb)</option>
                <option value="de">Немачка (de)</option>
                <option value="fr">Француска (fr)</option>
                <option value="sv">Шведска (sv)</option>
                <option value="nl">Холандска (nl)</option>
                <option value="ru">Руска (ru)</option>
                <option value="es">Шпанска (es)</option>
                <option value="it">Италијанска (it)</option>
                <option value="pl">Пољска (pl)</option>
                <option value="war">Варај-варај (war)</option>
                <option value="zh">Кинеска (zh)</option>
                <option value="ja">Јапанска (ja)</option>
                <option value="sr">Српска (sr)</option>
                <option value="uk">Украјинска (uk)</option>
                <option value="custom">-- Ручни унос --</option>
            </select>
            <input type="text" id="customLang" class="custom-lang" placeholder="код">
            <input type="text" id="articleInput" placeholder="Наслов или QID (нпр. Q751734)">
            <button id="importBtn" class="btn-import">Учитај чланак</button>
        </div>
    </div>

    <h3>1. Изворни Вики текст</h3>
    <textarea id="rawWikiCode" placeholder="Овде ће се појавити изворни код чланка..."></textarea>
    
    <div class="grid">
        <button id="extractBtn" class="btn-extract">↓ Извуци шаблоне</button>
        <button id="extractCatBtn" class="btn-extract">↓ Извуци категорије</button>
    </div>

    <div id="status" class="status-msg" style="display:none;"></div>

    <div class="section">
        <h3>2. Шаблони за превод</h3>
        <textarea id="templateList"></textarea>
        <button id="processBtn" class="btn-main">Преведи шаблоне</button>
        <div id="outputDisplay" class="output-box"></div>
        <table id="templateTable">
            <thead>
                <tr>
                    <th>Изворни назив</th>
                    <th>Српски назив</th>
                    <th>Статус</th>
                    <th style="width:280px">Алатке за пренос</th>
                </tr>
            </thead>
            <tbody id="templateTableBody"></tbody>
        </table>
    </div>

    <div class="section-divider"></div>

    <div class="section">
        <h3>3. Категорије за превод</h3>
        <textarea id="categoryList"></textarea>
        <button id="processCatBtn" class="btn-cat">Преведи категорије</button>
        <div id="catOutputDisplay" class="output-box"></div>
        <table id="categoryTable">
            <thead>
                <tr><th>Изворна категорија</th><th>Српска категорија</th><th>Статус</th></tr>
            </thead>
            <tbody id="categoryTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const statusDiv = document.getElementById('status');
    const langSelect = document.getElementById('langSelect');
    const customLangInput = document.getElementById('customLang');

// Аутоматско попуњавање наслова из URL параметра
window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const titleParam = urlParams.get('wikiTitle');
    if (titleParam) {
        document.getElementById('articleInput').value = decodeURIComponent(titleParam);
        // Опционо: Аутоматски клик на "Учитај чланак"
        // document.getElementById('importBtn').click();
    }
};
    
    function updateStatus(msg, type) {
        statusDiv.style.display = "block";
        statusDiv.innerHTML = msg;
        statusDiv.style.background = (type === 'work') ? "#e3f2fd" : "#e8f5e9";
        statusDiv.style.color = (type === 'work') ? "#0d47a1" : "#1b5e20";
        statusDiv.style.borderColor = (type === 'work') ? "#bbdefb" : "#c8e6c9";
    }

    function getLangCode() {
        return langSelect.value === 'custom' ? customLangInput.value.trim().toLowerCase() : langSelect.value;
    }

    // --- ПОПРАВЉЕНА ФУНКЦИЈА ЗА IMPORT (QID FIX) ---
    document.getElementById('importBtn').addEventListener('click', async () => {
        let input = document.getElementById('articleInput').value.trim();
        const lang = getLangCode();
        if (!input) return;

        updateStatus("Преузимање података...", "work");
        document.getElementById('importBtn').disabled = true;

        try {
            let titleToFetch = input;

            // Ако је унет QID
            if (/^Q\d+$/.test(input.toUpperCase())) {
                const wdUrl = `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${input.toUpperCase()}&props=sitelinks&format=json&origin=*`;
                const wdRes = await fetch(wdUrl).then(r => r.json());
                const entity = wdRes.entities[input.toUpperCase()];
                
                // Проверавамо да ли постоји сителинк за изабрани језик (нпр. enwiki, srwiki)
                const sitelink = entity.sitelinks[`${lang}wiki`];
                if (!sitelink) throw new Error(`Овај QID нема везу са ${lang} Википедијом.`);
                titleToFetch = sitelink.title;
            }

            // Дохватање Wikitext-а (са redirects=1)
            const apiUrl = `https://${lang}.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(titleToFetch)}&prop=wikitext&format=json&origin=*&redirects=1`;
            const res = await fetch(apiUrl).then(r => r.json());
            
            if (res.error) throw new Error(res.error.info);

            document.getElementById('rawWikiCode').value = res.parse.wikitext['*'];
            updateStatus(`<b>Успех!</b> Чланак "<b>${titleToFetch}</b>" је учитан.`, "success");
        } catch (e) {
            updateStatus(`<b>Грешка:</b> ${e.message}`, "work");
            statusDiv.style.background = "#ffebee";
            statusDiv.style.color = "#b71c1c";
        } finally {
            document.getElementById('importBtn').disabled = false;
        }
    });

    // --- ОСТАЛЕ ФУНКЦИЈЕ (ЗАДРЖАНЕ) ---
    async function fetchWikiSource(title, lang) {
        try {
            const url = `https://${lang}.wikipedia.org/w/api.php?action=query&prop=revisions&titles=${encodeURIComponent(title)}&rvprop=content&format=json&origin=*&redirects=1`;
            const res = await fetch(url).then(r => r.json());
            const pages = res.query.pages;
            const pageId = Object.keys(pages)[0];
            return pageId === "-1" ? null : pages[pageId].revisions[0]['*'];
        } catch (e) { return null; }
    }

    async function handleTransferTool(templateName, mode) {
        const lang = getLangCode();
        updateStatus(`API преузимање: ${templateName}...`, 'work');
        const mainCode = await fetchWikiSource(`Template:${templateName}`, lang);
        if (!mainCode) { alert("Грешка при преузимању."); return; }
        if (mode === 'code') {
            await navigator.clipboard.writeText(mainCode); alert("Копирано!");
        } else {
            const docCode = await fetchWikiSource(`Template:${templateName}/doc`, lang);
            if (mode === 'doc') {
                await navigator.clipboard.writeText(docCode || "Нема документације."); alert("Копирано!");
            } else {
                const unified = `Ово је код:\n"${mainCode}"\n\nА ово је документациона страна:\n"${docCode || "НЕМА ДОКУМЕНТАЦИЈЕ"}"`;
                await navigator.clipboard.writeText(unified); alert("Обједињено копирано!");
            }
        }
        updateStatus("Спремно!", "success");
    }

    document.getElementById('extractBtn').addEventListener('click', () => {
        const matches = [...document.getElementById('rawWikiCode').value.matchAll(/\{\{\s*([^|{}\n\]]+)/g)];
        let unique = [];
        matches.forEach(m => { if(!unique.includes(m[1].trim())) unique.push(m[1].trim()); });
        document.getElementById('templateList').value = unique.map(n => `{{${n}}}`).join('\n');
    });

    document.getElementById('extractCatBtn').addEventListener('click', () => {
        const matches = [...document.getElementById('rawWikiCode').value.matchAll(/\[\[\s*(Category|Категорија|Kategorija|Kategorie|Catégorie):\s*([^\]|]+)/gi)];
        let unique = [];
        matches.forEach(m => { if(!unique.includes(m[2].trim())) unique.push(m[2].trim()); });
        document.getElementById('categoryList').value = unique.map(n => `[[Category:${n}]]`).join('\n');
    });

    async function runTranslation(listId, outputId, tableBodyId, type) {
        const text = document.getElementById(listId).value.trim();
        if (!text) return;
        const regex = type === 'Шаблон' ? /\{\{(.*?)\}\}/g : /\[\[Category:(.*?)\]\]/gi;
        const matches = [...text.matchAll(regex)];
        const langSource = getLangCode();
        document.querySelectorAll('button').forEach(b => b.disabled = true);
        
        let results = [];
        for (let i = 0; i < matches.length; i++) {
            const name = matches[i][1].trim();
            updateStatus(`Обрада ${i+1}/${matches.length}: ${name}`, 'work');
            await new Promise(r => setTimeout(r, 10));
            const translated = await translateWikiItem(name, type === 'Шаблон' ? 'Template:' : 'Category:', langSource);
            results.push({ full: matches[i][0], name, translated, index: i });
        }

        results.sort((a, b) => (!!a.translated === !!b.translated) ? a.index - b.index : a.translated ? -1 : 1);
        const tableBody = document.getElementById(tableBodyId);
        tableBody.innerHTML = "";
        let htmlOut = "";

        results.forEach(res => {
            const isFound = !!res.translated;
            const disp = isFound ? (type === 'Шаблон' ? `{{${res.translated}}}` : `[[Категорија:${res.translated}]]`) : res.full;
            htmlOut += `<span class="${isFound ? 'found' : 'not-found'}">${disp}</span>`;
            const row = `<tr class="${isFound ? 'found-row' : 'not-found-row'}">
                <td><a href="https://${langSource}.wikipedia.org/wiki/${type==='Шаблон'?'Template':'Category'}:${encodeURIComponent(res.name)}" target="_blank">${res.name}</a></td>
                <td>${isFound ? res.translated : '—'}</td>
                <td>${isFound ? '✅' : '❌'}</td>
                ${type === 'Шаблон' ? `<td>${!isFound ? `<button class="btn-tool" onclick="handleTransferTool('${res.name}', 'code')">Код</button><button class="btn-tool" onclick="handleTransferTool('${res.name}', 'doc')">Док</button><button class="btn-tool btn-unified" onclick="handleTransferTool('${res.name}', 'unified')">Обједињено</button>` : '—'}</td>` : ''}
            </tr>`;
            tableBody.insertAdjacentHTML('beforeend', row);
        });
        document.getElementById(outputId).innerHTML = htmlOut;
        document.querySelectorAll('button').forEach(b => b.disabled = false);
        updateStatus("Завршено!", "success");
    }

    document.getElementById('processBtn').addEventListener('click', () => runTranslation('templateList', 'outputDisplay', 'templateTableBody', 'Шаблон'));
    document.getElementById('processCatBtn').addEventListener('click', () => runTranslation('categoryList', 'catOutputDisplay', 'categoryTableBody', 'Категорија'));

    async function translateWikiItem(title, prefix, lang) {
        try {
            const res = await fetch(`https://${lang}.wikipedia.org/w/api.php?action=query&prop=pageprops&titles=${encodeURIComponent(prefix + title)}&format=json&origin=*&redirects=1`).then(r => r.json());
            const pageId = Object.keys(res.query.pages)[0];
            const qid = res.query.pages[pageId].pageprops?.wikibase_item;
            if (!qid) return null;
            const wd = await fetch(`https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${qid}&props=sitelinks&sitefilter=srwiki&format=json&origin=*`).then(r => r.json());
            const sr = wd.entities[qid].sitelinks?.srwiki?.title;
            return sr ? sr.substring(sr.indexOf(':') + 1) : null;
        } catch (e) { return null; }
    }
</script>

</body>

</html>
